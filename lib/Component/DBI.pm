package Component::DBI;
use utf8;
use strict;
use warnings;
use Config::Tiny;
use Storable qw(freeze thaw);
use DBI;

use Exporter qw(import);

our @EXPORT = qw( cve_add cve_get );

my $config = Config::Tiny->read('config.ini', 'utf8');
my ($logf, $dsn, $dbh);

sub new {
    my ($self, $bot, %args) = @_;
    my %attr = ( PrintError => 0, RaiseError => 1 );
    
    $dsn = sprintf "DBI:MariaDB:database=%s;host=%s", $config->{'cvebot'}{'dbname'}, $config->{'cvebot'}{'dbhost'};
    $dbh = DBI->connect($dsn, $config->{'cvebot'}{'dbuser'}, $config->{'cvebot'}{'dbpass'}, \%attr) or die $!;

    return bless \%args, $self;
}

sub cve_get {
    my ($self, $id) = @_;

    my $sql = "SELECT storage FROM cve WHERE id = ?";
    my $sth = $dbh->prepare($sql);

    $sth->execute($id);
    return $sth->fetchrow_arrayref();
} 

sub cve_add {
    my ($self, $id, $status, $storage) = @_;

    my $sql = "INSERT INTO cve (id, status, storage) VALUES(?, ?, ?)";
    my $sth = $dbh->prepare($sql);

    $sth->execute($id, $status, freeze($storage));
}

sub dbh { return $dbh; }

1;
