package Component::DBI;
use utf8;
use strict;
use warnings;
use Config::Tiny;
use Storable qw(freeze thaw);
use DBI;
use Data::Dumper;

use Exporter qw(import);

our @EXPORT = qw( cve_add cve_get cve_search cve_getStorage cve_setStorage cve_setStatus );

my $config = Config::Tiny->read('config.ini', 'utf8');
my ($logf, $dsn, $dbh);

sub new {
    my ($self, $bot, %args) = @_;
    my %attr = ( PrintError => 0, RaiseError => 1 );
    
    $dsn = sprintf "DBI:MariaDB:database=%s;host=%s", $config->{'cvebot'}{'dbname'}, $config->{'cvebot'}{'dbhost'};
    $dbh = DBI->connect($dsn, $config->{'cvebot'}{'dbuser'}, $config->{'cvebot'}{'dbpass'}, \%attr) or die $!;

    return bless \%args, $self;
}

sub cve_get {
    my ($self, $id) = @_;

    my $sql = "SELECT * FROM cve WHERE id = ?";
    my $sth = $dbh->prepare($sql);

    $sth->execute($id);
    return $sth->fetchrow_hashref();
} 

sub cve_add {
    my ($self, $id, $desc, $link, $status, $storage) = @_;

    my $sql = "INSERT INTO cve VALUES (?, ?, ?, ?, ?)";
    my $sth = $dbh->prepare($sql);

    $sth->execute($id, $desc, $link, $status, freeze($storage));
}


sub cve_getStorage {
    my ($self, $id) = @_;

    my $sql = "SELECT storage FROM cve WHERE id = ?";
    my $sth = $dbh->prepare($sql);
    $sth->execute($id);

    my $thaw = thaw($sth->fetchrow_array());

    return $thaw;
}


sub cve_setStorage {
    my ($self, $id, $data) = @_;

    my $sql = "UPDATE cve SET storage = ? WHERE id = ?";
    my $sth = $dbh->prepare($sql);

    $sth->execute(freeze($data), $id) 
}

sub cve_setStatus {

}


sub cve_search {
    my ($self, $search) = @_;

    my $sql = "SELECT * FROM cve";
    my $sth = $dbh->prepare($sql);

    $sth->execute();
    my @search;
    while (my $row = $sth->fetchrow_hashref()) {
        my @string = split /\s+/, $search;
        my $i = 0;

        for (@string) {
            ++$i if $row->{'desc'} =~ /$_/i
        }
        
        if (scalar @string == $i) {
            push @search, $row;
        }
    }

    return @search;
} 

sub dbh { return $dbh; }

1;
